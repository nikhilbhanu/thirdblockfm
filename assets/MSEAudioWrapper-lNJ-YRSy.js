import{C as T}from"./index-C80y8H7_.js";const A="mp4",l="webm",d="mp3",g="mp4a.40.2",m="flac",w="vorbis",h="opus",b="audio/",S=";codecs=",f=b+A+S,y=b+l+S,u="mse-audio-wrapper";class r{constructor({name:t,contents:e=[],children:s=[]}){this._name=t,this._contents=e,this._children=s}static stringToByteArray(t){return[...t].map(e=>e.charCodeAt(0))}static getFloat64(t){const e=new Uint8Array(8);return new DataView(e.buffer).setFloat64(0,t),e}static getUint64(t){const e=new Uint8Array(8);return new DataView(e.buffer).setBigUint64(0,BigInt(t)),e}static getUint32(t){const e=new Uint8Array(4);return new DataView(e.buffer).setUint32(0,t),e}static getUint16(t){const e=new Uint8Array(2);return new DataView(e.buffer).setUint16(0,t),e}static getInt16(t){const e=new Uint8Array(2);return new DataView(e.buffer).setInt16(0,t),e}static*flatten(t){for(const e of t)Array.isArray(e)?yield*r.flatten(e):yield e}get contents(){const t=new Uint8Array(this.length),e=this._buildContents();let s=0;for(const c of r.flatten(e))typeof c!="object"?(t[s]=c,s++):(t.set(c,s),s+=c.length);return t}get length(){return this._buildLength()}_buildContents(){return[this._contents,...this._children.map(t=>t._buildContents())]}_buildLength(){let t;return Array.isArray(this._contents)?t=this._contents.reduce((e,s)=>e+(s.length===void 0?1:s.length),0):t=this._contents.length===void 0?1:this._contents.length,t+this._children.reduce((e,s)=>e+s.length,0)}addChild(t){this._children.push(t)}}class n extends r{constructor(t,{contents:e,children:s}={}){super({name:t,contents:e,children:s})}_buildContents(){return[...this._lengthBytes,...r.stringToByteArray(this._name),...super._buildContents()]}_buildLength(){return this._length||(this._length=4+this._name.length+super._buildLength(),this._lengthBytes=r.getUint32(this._length)),this._length}}class o extends r{constructor(t,{contents:e,tags:s}={}){super({name:t,contents:e,children:s})}static getLength(t){const e=r.getUint32(t);return e.every((s,c,_)=>s===0?(_[c]=128,!0):!1),e}_buildContents(){return[this._name,...this._lengthBytes,...super._buildContents()]}_buildLength(){if(!this._length){const t=super._buildLength();this._lengthBytes=o.getLength(t),this._length=1+t+this._lengthBytes.length}return this._length}addTag(t){this.addChild(t)}}class p{constructor(t){this._codec=t}getCodecBox(t){switch(this._codec){case d:return this.getMp4a(t,107);case g:return this.getMp4a(t,64);case h:return this.getOpus(t);case m:return this.getFlaC(t)}}getOpus(t){return new n("Opus",{contents:[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channels,0,t.bitDepth,0,0,0,0,n.getUint16(t.sampleRate),0,0],children:[new n("dOps",{contents:[0,t.channels,n.getUint16(t.preSkip),n.getUint32(t.inputSampleRate),n.getInt16(t.outputGain),t.channelMappingFamily,t.channelMappingFamily!==0?[t.streamCount,t.coupledStreamCount,t.channelMappingTable]:[]]})]})}getFlaC(t){return new n("fLaC",{contents:[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channels,0,t.bitDepth,0,0,0,0,n.getUint16(t.sampleRate),0,0],children:[new n("dfLa",{contents:[0,0,0,0,...t.streamInfo||[128,0,0,34,n.getUint16(t.blockSize),n.getUint16(t.blockSize),0,0,0,0,0,0,n.getUint32(t.sampleRate<<12|t.channels<<8|t.bitDepth-1<<4),0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]})]})}getMp4a(t,e){const s=new o(4,{contents:[e,21,0,0,0,0,0,0,0,0,0,0,0]});return e===64&&s.addTag(new o(5,{contents:t.audioSpecificConfig})),new n("mp4a",{contents:[0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channels,0,16,0,0,0,0,n.getUint16(t.sampleRate),0,0],children:[new n("esds",{contents:[0,0,0,0],children:[new o(3,{contents:[0,1,0],tags:[s,new o(6,{contents:2})]})]})]})}getInitializationSegment({header:t,samples:e}){return new r({children:[new n("ftyp",{contents:[n.stringToByteArray("iso5"),0,0,2,0,n.stringToByteArray("iso6mp41")]}),new n("moov",{children:[new n("mvhd",{contents:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,232,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2]}),new n("trak",{children:[new n("tkhd",{contents:[0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0]}),new n("mdia",{children:[new n("mdhd",{contents:[0,0,0,0,0,0,0,0,0,0,0,0,n.getUint32(t.sampleRate),0,0,0,0,85,196,0,0]}),new n("hdlr",{contents:[0,0,0,0,n.stringToByteArray("mhlr"),n.stringToByteArray("soun"),0,0,0,0,0,0,0,0,0,0,0,0,0]}),new n("minf",{children:[new n("stbl",{children:[new n("stsd",{contents:[0,0,0,0,0,0,0,1],children:[this.getCodecBox(t)]}),new n("stts",{contents:[0,0,0,0,0,0,0,0]}),new n("stsc",{contents:[0,0,0,0,0,0,0,0]}),new n("stsz",{contents:[0,0,0,0,0,0,0,0,0,0,0,0]}),new n("stco",{contents:[0,0,0,0,0,0,0,0]})]})]})]})]}),new n("mvex",{children:[new n("trex",{contents:[0,0,0,0,0,0,0,1,0,0,0,1,n.getUint32(e),0,0,0,0,0,0,0,0]})]})]})]}).contents}getSamplesPerFrame(t){return this._codec===g?t.map(({data:e,header:s})=>n.getUint32(e.length-s.length)):t.map(({data:e})=>n.getUint32(e.length))}getFrameData(t){return this._codec===g?t.map(({data:e,header:s})=>e.subarray(s.length)):t.map(({data:e})=>e)}getMediaSegment(t){return new r({children:[new n("moof",{children:[new n("mfhd",{contents:[0,0,0,0,0,0,0,0]}),new n("traf",{children:[new n("tfhd",{contents:[0,2,0,0,0,0,0,1]}),new n("tfdt",{contents:[0,0,0,0,0,0,0,0]}),new n("trun",{contents:[0,0,2,1,n.getUint32(t.length),n.getUint32(92+t.length*4),...this.getSamplesPerFrame(t)]})]})]}),new n("mdat",{contents:this.getFrameData(t)})]}).contents}}const E=(...a)=>a.flatMap(t=>{const e=[];for(let s=t.length;s>=0;s-=255)e.push(s>=255?255:s);return e}),U=(...a)=>{console.error(u,a.reduce((t,e)=>t+`
  `+e,""))};class x extends r{constructor(t,{contents:e,children:s,isUnknownLength:c=!1}={}){super({name:t,contents:e,children:s}),this._isUnknownLength=c}static getUintVariable(t){let e;if(t<127)e=[128|t];else if(t<16383)e=r.getUint16(t),e[0]|=64;else if(t<2097151)e=r.getUint32(t).subarray(1),e[0]|=32;else if(t<268435455)e=r.getUint32(t),e[0]|=16;else if(t<34359738367)e=r.getUint64(t).subarray(3),e[0]|=8;else if(t<4398046511103)e=r.getUint64(t).subarray(2),e[0]|=4;else if(t<562949953421311)e=r.getUint64(t).subarray(1),e[0]|=2;else if(t<72057594037927940)e=r.getUint64(t),e[0]|=1;else if(typeof t!="number"||isNaN(t))throw U(`EBML Variable integer must be a number, instead received ${t}`),new Error(u+": Unable to encode WEBM");return e}_buildContents(){return[...this._name,...this._lengthBytes,...super._buildContents()]}_buildLength(){return this._length||(this._contentLength=super._buildLength(),this._lengthBytes=this._isUnknownLength?[1,255,255,255,255,255,255,255]:x.getUintVariable(this._contentLength),this._length=this._name.length+this._lengthBytes.length+this._contentLength),this._length}}const i={Audio:[225],BitDepth:[98,100],Channels:[159],Cluster:[31,67,182,117],CodecDelay:[86,170],CodecID:[134],CodecPrivate:[99,162],DocType:[66,130],DocTypeReadVersion:[66,133],DocTypeVersion:[66,135],EBML:[26,69,223,163],EBMLMaxIDLength:[66,242],EBMLMaxSizeLength:[66,243],EBMLReadVersion:[66,247],EBMLVersion:[66,134],FlagLacing:[156],Info:[21,73,169,102],MuxingApp:[77,128],SamplingFrequency:[181],SeekPreRoll:[86,187],Segment:[24,83,128,103],SimpleBlock:[163],Timestamp:[231],TimestampScale:[42,215,177],TrackEntry:[174],TrackNumber:[215],Tracks:[22,84,174,107],TrackType:[131],TrackUID:[115,197],WritingApp:[87,65]};class M{constructor(t){switch(t){case h:{this._codecId="A_OPUS",this._getCodecSpecificTrack=e=>[new x(i.CodecDelay,{contents:x.getUint32(Math.round(e.preSkip*this._timestampScale))}),new x(i.SeekPreRoll,{contents:x.getUint32(Math.round(3840*this._timestampScale))}),new x(i.CodecPrivate,{contents:e.data})];break}case w:{this._codecId="A_VORBIS",this._getCodecSpecificTrack=e=>[new x(i.CodecPrivate,{contents:[2,E(e.data,e.vorbisComments),e.data,e.vorbisComments,e.vorbisSetup]})];break}}}getInitializationSegment({header:t}){return this._timestampScale=1e9/t.sampleRate,new r({children:[new x(i.EBML,{children:[new x(i.EBMLVersion,{contents:1}),new x(i.EBMLReadVersion,{contents:1}),new x(i.EBMLMaxIDLength,{contents:4}),new x(i.EBMLMaxSizeLength,{contents:8}),new x(i.DocType,{contents:x.stringToByteArray(l)}),new x(i.DocTypeVersion,{contents:4}),new x(i.DocTypeReadVersion,{contents:2})]}),new x(i.Segment,{isUnknownLength:!0,children:[new x(i.Info,{children:[new x(i.TimestampScale,{contents:x.getUint32(Math.floor(this._timestampScale))}),new x(i.MuxingApp,{contents:x.stringToByteArray(u)}),new x(i.WritingApp,{contents:x.stringToByteArray(u)})]}),new x(i.Tracks,{children:[new x(i.TrackEntry,{children:[new x(i.TrackNumber,{contents:1}),new x(i.TrackUID,{contents:1}),new x(i.FlagLacing,{contents:0}),new x(i.CodecID,{contents:x.stringToByteArray(this._codecId)}),new x(i.TrackType,{contents:2}),new x(i.Audio,{children:[new x(i.Channels,{contents:t.channels}),new x(i.SamplingFrequency,{contents:x.getFloat64(t.sampleRate)}),new x(i.BitDepth,{contents:t.bitDepth})]}),...this._getCodecSpecificTrack(t)]})]})]})]}).contents}getMediaSegment(t){const e=t[0].totalSamples;return new x(i.Cluster,{children:[new x(i.Timestamp,{contents:x.getUintVariable(e)}),...t.map(({data:s,totalSamples:c})=>new x(i.SimpleBlock,{contents:[129,x.getInt16(c-e),128,s]}))]}).contents}}const C=()=>{},B=(a,t=l)=>{switch(a){case"mpeg":return`${f}"${d}"`;case"aac":return`${f}"${g}"`;case"flac":return`${f}"${m}"`;case"vorbis":return`${y}"${w}"`;case"opus":return t===l?`${y}"${h}"`:`${f}"${h}"`}};class R{constructor(t,e={}){this._inputMimeType=t,this.PREFERRED_CONTAINER=e.preferredContainer||l,this.MIN_FRAMES=e.minFramesPerSegment||4,this.MAX_FRAMES=e.maxFramesPerSegment||50,this.MIN_FRAMES_LENGTH=e.minBytesPerSegment||1022,this.MAX_SAMPLES_PER_SEGMENT=1/0,this._onMimeType=e.onMimeType||C,e.codec&&(this._container=this._getContainer(e.codec),this._onMimeType(this._mimeType)),this._frames=[],this._codecParser=new T(t,{onCodec:s=>{this._container=this._getContainer(s),this._onMimeType(this._mimeType)},onCodecUpdate:e.onCodecUpdate,enableLogging:e.enableLogging,enableFrameCRC32:!1})}get mimeType(){return this._mimeType}get inputMimeType(){return this._inputMimeType}*iterator(t){t.constructor===Uint8Array?yield*this._processFrames([...this._codecParser.parseChunk(t)].flatMap(e=>e.codecFrames||e)):Array.isArray(t)&&(yield*this._processFrames(t))}*_processFrames(t){if(this._frames.push(...t),this._frames.length){const e=this._groupFrames();if(e.length){this._sentInitialSegment||(this._sentInitialSegment=!0,yield this._container.getInitializationSegment(e[0][0]));for(const s of e)yield this._container.getMediaSegment(s)}}}_groupFrames(){const t=[[]];let e=t[0],s=0;for(const c of this._frames)(e.length===this.MAX_FRAMES||s>=this.MAX_SAMPLES_PER_SEGMENT)&&(s=0,t.push(e=[])),e.push(c),s+=c.samples;return this._frames=e.length<this.MIN_FRAMES||e.reduce((c,_)=>c+_.data.length,0)<this.MIN_FRAMES_LENGTH?t.pop():[],t}_getContainer(t){switch(this._mimeType=B(t,this.PREFERRED_CONTAINER),t){case"mpeg":return new p(d);case"aac":return new p(g);case"flac":return new p(m);case"vorbis":return this.MAX_SAMPLES_PER_SEGMENT=32767,new M(w);case"opus":return this.PREFERRED_CONTAINER===l?(this.MAX_SAMPLES_PER_SEGMENT=32767,new M(h)):new p(h)}}}export{R as default,B as getWrappedMimeType};
